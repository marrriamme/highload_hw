# Highload

[Задание](https://github.com/init/highload/blob/main/homework_architecture.md)

Репозиторий курсовой работы по дисциплине "Проектирование высоконагруженных систем"

[**1. Тема и целевая аудитория**](#1-тема-и-целевая-аудитория)
[**2. Расчет нагрузки**](#2-расчет-нагрузки)
[**3. Глобальная балансировка нагрузки**](#3-глобальная-балансировка-нагрузки)
[**4. Локальная балансировка нагрузки**](#4-локальная-балансировка-нагрузки)

[**Список использованных источников**](#список-использованных-источников)


## 1. Тема и целевая аудитория

Duolingo — бесплатная платформа для изучения языков, также имеющая курсы математики, музыки и шахматам[[1](https://ru.wikipedia.org/wiki/Duolingo)].

### Число активных пользователей

  * MAU на 1 квартал 2022 года: 49,2 млн[[2](https://investors.duolingo.com/static-files/d667f9d1-8f7f-418c-b116-e699a30a9826)]
  * DAU на 1 квартал 2022 года: 12,5 млн 
  * Средняя продолжительность посещения: 15 минут 39 секунд [[3](https://usesignhouse.com/blog/duolingo-stats/)]

### Целевая аудитория

* По странам[[4](https://usesignhouse.com/blog/duolingo-stats/)]:

  ![image](./images/cantry.jpg "Статистика использования по cтранам")
  Всего пользователей: 575 млн[[5](https://cooljugator.com/blog/duolingo-statistics/)]

### Требования к функционалу
  * Регистрация и авторизация
  * Выбор языка для изучения
  * Уроки (с делением на разделы и модули)
    - множественный выбор
    - сопоставление слов
    - аудирование
    - говорение
    - правописание
  * Система прогресса 
  * Ежедневная цель и трекер
  * Система напоминаний
  * Подписки, добавление в друзья, комментарии
  * Алфавит
  * Возможность изменения уроков их авторами

## 2. Расчет нагрузки

| Метрика                          | Значение    |
|:---------------------------------|:------------| 
| Месячная аудитория (MAU)         | 49,2 млн    |
| Дневная аудитория (DAU)          | 12,5 млн    | 
| Средняя продолжительность сессии | 15,65 минут | 

### Размер хранения в разбивке по типам данных

- Прирост в день:[[8](https://www.statista.com/statistics/1309604/duolingo-quarterly-dau/)]
  ![image](./images/dau.jpg "Статистика роста DAU")
- Прирост в месяц:
  ![image](./images/mau.jpg "Статистика роста MAU")

Согласно источнику[[6](https://hu.duolingo.com/privacy)], хранятся следующие индивидуальные пользовательские данные:
- основной профиль и учетные данные: возраст, email, номер телефона, имя, фамилия, биография, фото профиля;
- учебный прогресс и активность: изучаемые языки, статистика, достижения, история пройденных уроков и упражнений;
- пользовательский контент: комментарии на профиле;
- аудиоданные и транскрипты: аудиозаписи голоса с упражнений на произношение;
- cоциальные графы: cписки подписчиков и подписок.

Формулы:
- новых пользователей в день ≈ (DAU_конечное - DAU_начальное) / количество дней в периоде
- прирост в день ед/день = ед/пользователя × новых пользователей в день
- прирост в день объем/день = ед/день × средний размер единицы
- прирост в месяц ед/мес = ед/пользователя × новых пользователей в месяц
- прирост в месяц объем/мес = ед/мес × средний размер единицы

Новых пользователей в день: 
- (12.5 млн - 10.1 млн) / 90 дней = 2.4 млн / 90 = 26,667 пользователей/день

Новых пользователей в месяц:
- 26,700 пользователей/день × 30 дней = 801,000 пользователей/месяц

| Хранимые данные                   | Средний размер единицы | Ед/пользователя | Сколько единиц | Суммарный объем | Прирост в день | Прирост в месяц |
|:----------------------------------|:-----------------------|:----------------|:---------------|:----------------|:---------------|:----------------|
| Основной профиль и учетные данные | 5 КБ                   | 1               | 49,200,000     | 234.5 ГБ        | 130.4 МБ       | 3.8 ГБ          |
| Учебный прогресс и активность     | 50 КБ                  | 1               | 49,200,000     | 2.3 ТБ          | 1.3 ГБ         | 38.2 ГБ         |
| Пользовательский контент          | 2 КБ                   | 5               | 246,000,000    | 468.9 ГБ        | 260.7 МБ       | 7.6 ГБ          |
| Аудиоданные и транскрипты         | 4.8 МБ                 | 1               | 49,200,000     | 225.2 ТБ        | 125.1 ГБ       | 3.7 ТБ          |
| Социальные графы                  | 1 КБ                   | 10              | 492,000,000    | 468.9 ГБ        | 260.7 МБ       | 7.6 ГБ          |

Основной профиль и учетные данные:
- Сколько единиц: MAU (49.2 млн) × 1 = 49,200,000
- Суммарный объем: (49,200,000 × 5 КБ) / (1024×1024) = 234.5 ГБ
- Прирост в день: (26,700 × 5 КБ) / 1024 = 130.4 МБ
- Прирост в месяц: 130.4 МБ × 30 = 3.8 ГБ

Учебный прогресс и активность:
- Суммарный объем: (49,200,000 × 50 КБ) / (1024×1024) = 2.3 ТБ
- Прирост в день: (26,700 × 50 КБ) / 1024 = 1.3 ГБ

Пользовательский контент:
- Сколько единиц: MAU (49.2 млн) × 5 = 246,000,000
- Суммарный объем: (246,000,000 × 2 КБ) / (1024×1024) = 468.9 ГБ
- Прирост в день: (26,700 × 5 × 2 КБ) / 1024 = 260.7 МБ

Аудиоданные и транскрипты:
- Размер единицы: 2.4 МБ/мин × 2 минуты = 4.8 МБ
- Сколько единиц: MAU (49.2 млн) × 1 = 49,200,000
- Суммарный объем: (49,200,000 × 4.8 МБ) / 1024 = 225.2 ТБ
- Прирост в день: (26,700 × 4.8 МБ) / 1024 = 125.1 ГБ
- Прирост в месяц: 125.1 ГБ × 30 = 3.7 ТБ

Социальные графы:
- Сколько единиц: MAU (49.2 млн) × 10 = 492,000,000
- Суммарный объем: (492,000,000 × 1 КБ) / (1024×1024) = 468.9 ГБ
- Прирост в день: (26,700 × 10 × 1 КБ) / 1024 = 260.7 МБ
   
Допущения:
- Высокое качество(320kbps) аудиозаписи: 2,40 МБ/мин [[7](https://digitark.telia.ee/ru/era/%D0%B2%D1%81%D0%B5-%D1%82%D0%BE%D1%87%D0%BA%D0%B8-%D0%BD%D0%B0%D0%B4-%D0%B8%D1%82-%D0%BA%D0%B0%D0%BA-%D0%B2%D1%8B%D0%B1%D1%80%D0%B0%D1%82%D1%8C-%D0%BE%D0%B1%D1%8A%D0%B5%D0%BC-%D0%BC%D0%BE/#:~:text=%D0%9D%D0%B8%D0%B7%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%B0%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%BE%20%D0%B0%D1%83%D0%B4%D0%B8%D0%BE%20(96kpps)%20%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D1%83%D0%B5%D1%82,115%2C2%20%D0%9C%D0%B1%20%D0%B2%20%D1%87%D0%B0%D1%81.)]
- На говорение тратится ~2 минуты за сессию.

### RPS в разбивке по типам запросов

Формулы:
- суммарные действия в день = действий в день на пользователя ×  DAU
- средний RPS = суммарные действия в день / 86 400 (секунд в дне)

| Категория                 | Действие                           | Среднее количество в день             | Суммарные действия в день | Средний RPS |
|:--------------------------|:-----------------------------------|:--------------------------------------|:--------------------------|:------------|
| Регистрация и авторизация |                                    |                                       |                           |             |
|                           | Вход в аккаунт                     | 2                                     | 25 000 000                | ~289.4      |
| Работа с уроками          |                                    |                                       |                           |             |
|                           | Прохождение карточек / множ. выбор | 12                                    | 150 000 000               | ~1736.1     | 
|                           | Сопоставление слов                 | 5                                     | 62 500 000                | ~723.4      | 
|                           | Аудирование                        | 4                                     | 50 000 000                | ~578.7      | 
|                           | Говорение (произношение)           | 3                                     | 37 500 000                | ~434.0      | 
|                           | Правописание (ввод слова)          | 4                                     | 50 000 000                | ~578.7      | 
|                           | ИТОГО по урокам                    | 28                                    | 350 000 000               | ~4050.9     | 
| Система прогресса         |                                    |                                       |                           |             | 
|                           | Просмотр статистики                | 1                                     | 12 500 000                | ~144.7      | 
| Ежедневная цель           |                                    |                                       |                           |             |  
|                           | Отметка о выполнении               | 1                                     | 12 500 000                | ~144.7      |
| Система напоминаний       |                                    |                                       |                           |             |
|                           | Клик по push-уведомлению           | 0.5                                   | 6 250 000                 | ~72.3       |
| Социальные функции        |                                    |                                       |                           |             | 
|                           | Запрос на дружбу                   | 0.3                                   | 3 750 000                 | ~43.4       |
|                           | Комментарии                        | 1.5                                   | 18 750 000                | ~217.0      |
|                           | Просмотр профилей                  | 1                                     | 12 500 000                | ~144.7      |
|                           | ИТОГО по соц. функциям             | 2.8                                   | 35 000 000                | ~405.1      |
| Вспомогательные функции   |                                    |                                       |                           |             |
|                           | Просмотр алфавита                  | 0.2                                   | 2 500 000                 | ~28.9       |
|                           | Изменение уроков (автор)           | 0.1                                   | 1 250 000                 | ~14.5       |
|                           | ВСЕГО СУММАРНО                     | 35.7                                  | ~446 250 000              | ~5165.9     |

### Сетевой трафик

Формулы:
- нагрузка Гбит/с = (средний трафик на действие Кб × RPS × 8) / 1024 × 1024

| Действие                     | КБ на действие | RPS     | Нагрузка (Гбит/с) | Нагрузка (Гбит/день) |
|:-----------------------------|:---------------|:--------|:------------------|:---------------------|
| Вход в аккаунт               | 2              | 289.4   | 0.45              | 381.47               |
| Прохождение карточек         | 8              | 1,736.1 | 10.85             | 9,155.27             |
| Сопоставление слов           | 12             | 723.4   | 6.78              | 5,722.05             |
| Аудирование                  | 15             | 578.7   | 6.78              | 5,722.05             |
| Говорение                    | 5              | 434.0   | 1.70              | 1,430.51             |
| Правописание                 | 3              | 578.7   | 1.36              | 1,144.41             |
| Просмотр статистики          | 25             | 144.7   | 28.26             | 2,384.19             |
| Отметка о выполнении         | 1              | 144.7   | 1.13              | 95.37                |
| Клик по push-уведомлению     | 1              | 72.3    | 0.56              | 47.68                |
| Запрос на дружбу             | 2              | 43.4    | 0.68              | 57.22                |
| Комментарии                  | 8              | 217.0   | 13.56             | 1,144.41             |
| Просмотр профилей            | 15             | 144.7   | 16.96             | 1,430.51             |
| Просмотр алфавита            | 50             | 28.9    | 11.29             | 953.67               |
| Изменение уроков             | 100            | 14.5    | 11.33             | 953.67               |
| ВСЕГО СУММАРНО               | -              | 5,165.9 | 111.69            | 31,123.88            |

Вход в аккаунт:
- (2 КБ × 289.4 RPS × 8) / 1024 = 0.45 Гбит/с

Прохождение карточек:
- (8 КБ × 1,736.1 RPS × 8) / 1024 = 10.85 Гбит/с

Сопоставление слов:
- (12 КБ × 723.4 RPS × 8) / 1024 = 6.78 Гбит/с

Аудирование:
- (15 КБ × 578.7 RPS × 8) / 1024 = 6.78 Гбит/с

Просмотр статистики:
- (25 КБ × 144.7 RPS × 8) / 1024 = 28.26 Гбит/с

Изменение уроков:
- (100 КБ × 14.5 RPS × 8) / 1024 = 11.33 Гбит/с

| Метрика                      | Значение                                |
|:-----------------------------|:----------------------------------------|
| Общий суточный трафик        | 31,123.88 Гбит/день (см. табл. трафика) |
| Трафик на пользователя       | 0.305 МБ/день                           |
| Средний размер действия      | 8.75 КБ                                 |
| Действий на пользователя     | 35.7 действий/день (см. табл. RPS)      |

Средний размер на действие:
- 31,123,880 Мбит ÷ 446,250,000 действий ≈ 0.07 Мбит/действие = 8.75 КБ/действие

Трафик на пользователя:
- 35.7 действий/день × 8.75 КБ/действие = 312.4 КБ/день = 0.305 МБ/день

### Пиковый коэффициент и коэффициент надежности

Формулы:
- k<sub>пик</sub> = пиковая нагрузка / средняя нагрузка
- k<sub>надежн</sub> = доступные ресурсы / необходимые ресурсы

Пиковая нагрузка:
- 111.69 Гбит/с × 2 = 223.38 Гбит/с 
Нагрузка с резервом:
- 31,123,880 Мбит × 1.5 = 35.07 Гбит/с

Допущения:
- k<sub>пик</sub> = 2
- k<sub>надежн</sub> = 1.25

## 3. Глобальная балансировка нагрузки

### Функциональное разбиение по доменам

Отсутствует

### Обоснование расположения ДЦ (влияние на продуктовые метрики)

Из статистики получаем, что большая часть аудитории приходится на США, Бразилию, Великобританию, Мексику, поэтому распределим ДЦ следующим образом:

| Регион                   | Ключевые ДЦ                              | Покрытие                                    | Доля DAU     |
|:-------------------------|:-----------------------------------------|:--------------------------------------------|:-------------|
| США                      | Вирджиния, Орегон, Техас                 | США, Канада, Мексика                        | ~3 млн DAU   |
| Бразилия                 | Сан-Паулу                                | Бразилия, Латинская Америка                 | ~0.8 млн DAU |
| Великобритания, Германия | Лондон, Франкфурт                        | Великобритания, Германия, Франция, Бенилюкс | ~1 млн DAU   |
| Польша                   | Варшава                                  | Восточная Европа, Россия, СНГ               | ~0.5 млн DAU |                                                              |

#### США: 

- Крупнейший рынок. Несколько ДЦ для снижения задержки и обеспечения отказоустойчивости. Вирджиния - восточное побережье, Орегон - западное побережье, Техас - центр и юг.

#### Бразилия:

- Центральное расположение для покрытия всего региона. Сан-Паулу - крупнейший технологический хаб Южной Америки.

#### Великобритания, Германия:

- Два ключевых технологических хаба для покрытия основных рынков Европы. Лондон - западная Европа, Франкфурт - центральная Европа.

#### Польша:

- Центральное расположение для покрытия восточноевропейского региона с оптимальной задержкой для всех стран.

Общая мощность сети должна учитывать максимальную пиковую нагрузку  серверам средней производительности 

### Расчет распределение запросов по типам запросов по ДЦ

| Действие                               | Требование к задержке | Методы распределения в GSLB |
|:---------------------------------------|:----------------------|:----------------------------|
| Регистрация, авторизация               | низкая                | наименее загруженный ДЦ     |
| Главная страница, загрузка уроков      | средняя               | наименее загруженный ДЦ     |
| Упражнения на произношение             | критично важная       | ДЦ с наименьшей задержкой   |
| Упражнения на правописание             | критично важная       | ДЦ с наименьшей задержкой   |
| Прослушивание аудиозаписей, упражнения | средняя               | ближайшая геолокация        |

### Схема DNS балансировки

Для распределения пользователей между дата-центрами на разных континентах будет использоваться Latency-based DNS. 
Этот метод предпочтительнее простого Round-Robin, так как серверы находятся в разных полушариях и задержки между ними велики. 
Геолокационный подход (Geo-based) тоже мог бы подойти, но он не учитывает текущую загрузку каналов связи и зависит от точности определения местоположения по IP, что не всегда надежно.
DNS-система направляет пользователя не просто в географически ближайший дата-центр, а в тот, с которым у него на данный момент наименьшая круговая задержка (RTT).

### Схема Anycast балансировки

Внутри крупных регионов, таких как Северная Америка и Европа, DNS-балансировка может быть недостаточно точной из-за того, что провайдеры часто используют глобальные DNS-серверы, не учитывающие задержки между городами. Поэтому здесь будет применяться BGP Anycast.
Один и тот же IP-адрес анонсируется в интернет сразу из нескольких дата-центров. Протокол маршрутизации BGP автоматически направляет трафик пользователя в топологически ближайший ДЦ. Это минимизирует задержку для конечных пользователей.
Для реализации требуется собственный номер автономной системы (AS) и согласование с вышестоящими провайдерами.
Чтобы запросы в рамках одной пользовательской сессии не перенаправлялись между ДЦ, используется хеширование, которое гарантирует, что все соединения в рамках одной TCP-сессии попадут в один и тот же ДЦ.

### Механизм регулировки трафика между ДЦ

В зонах покрытия, где пользователи могут быть обслужены разными ДЦ (например, на границе их ответственности), трафик будет динамически перераспределяться в зависимости от текущей загрузки каждого ДЦ. Это обеспечивает оптимальное использование ресурсов и отказоустойчивость.

## 4. Локальная балансировка нагрузки

В каждом дата-центре развернут кластер Kubernetes, который обеспечивает оркестрацию и базовое управление состоянием сервисов:

Readiness Probe: Проверяет, готово ли приложение принимать трафик (например, завершило ли оно загрузку данных). Это предотвращает отправку запросов на неготовые экземпляры.
Liveness Probe: Проверяет, что приложение не просто запущено, но и функционирует корректно (например, может взаимодействовать с базой данных). Для этого используется специализированный эндпоинт (например, `cgi-bin/ping`), а не простой ping или проверка порта.
Autoscaling: Кластер автоматически масштабируется, увеличивая количество рабочих подов в часы пиковой нагрузки и уменьшая их, когда нагрузка спадает.

Для балансировки трафика между подами внутри кластера используется каскадная схема L4 → L7

### 1. L4-балансировщик (IP Tunneling)

При использовании NAT весь обратный трафик проходит через балансировщик, что создает узкое место и ограничивает пропускную способность, поэтому не используем. 
Не используем Direct Routing, т.к. он требует, чтобы все серверы находились в одной физической сети, что не всегда удобно и не является стандартом для современных облачных сред. 
IP Tunneling лишен этих недостатков: балансировщик инкапсулирует входящий пакет и пересылает его выбранному серверу через IP-туннель. Сервер извлекает оригинальный пакет и отвечает клиенту напрямую, минуя балансировщик на обратном пути. Это обеспечивает высокую производительность.
Для отказоустойчивости балансировщики объединяются в кластер с помощью протокола VRRP/CARP. Если основной балансировщик выходит из строя, его IP-адрес автоматически переносится на резервный.

### 2. L7-балансировщик (HTTP Reverse Proxy)
Поверх L4 работает балансировщик уровня приложений (например, Nginx), который расшифровывает HTTPS-трафика происходит на прокси, что разгружает backend-серверы, ускоряет доставку контента пользователям.
Nginx буферизует запросы и ответы, освобождая воркеры бэкенда от необходимости ждать, пока медленный клиент примет или отправит данные.
Позволяет перенаправлять запросы с упавших серверов на живые, делая сбой практически незаметным для пользователя.
Nginx поддерживает постоянные (keep-alive) соединения с бэкендами, экономя ресурсы на установке новых TCP-соединений. 
Используем алгоритм балансировки Least Connections. Запрос отправляется на сервер с наименьшим количеством активных соединений. Это оптимально для долгих и тяжелых запросов (например, обработки медиаконтента).
Настраиваются на основе 90-го перцентиля (p90) времени ответа, что является компромиссом между стабильностью и скоростью реакции.
Для оптимизации SSL используется ECDSA, который на 40–60% быстрее RSA и создает меньшую нагрузку на CPU.
Для минимизации дорогостоящих полных TLS-рукопожатий сессии кешируются. Чтобы кеш был валиден при любом раскладе балансировки, все backend-хосты в рамках одного ДЦ используют один общий секрет для возобновления сессий.

## Список использованных источников
1. https://ru.wikipedia.org/wiki/Duolingo
2. https://investors.duolingo.com/static-files/d667f9d1-8f7f-418c-b116-e699a30a9826
4. https://usesignhouse.com/blog/duolingo-stats/
5. https://cooljugator.com/blog/duolingo-statistics/
6. https://hu.duolingo.com/privacy
7. https://digitark.telia.ee/ru/era/%D0%B2%D1%81%D0%B5-%D1%82%D0%BE%D1%87%D0%BA%D0%B8-%D0%BD%D0%B0%D0%B4-%D0%B8%D1%82-%D0%BA%D0%B0%D0%BA-%D0%B2%D1%8B%D0%B1%D1%80%D0%B0%D1%82%D1%8C-%D0%BE%D0%B1%D1%8A%D0%B5%D0%BC-%D0%BC%D0%BE/#:~:text=%D0%9D%D0%B8%D0%B7%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%B0%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%BE%20%D0%B0%D1%83%D0%B4%D0%B8%D0%BE%20(96kpps)%20%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D1%83%D0%B5%D1%82,115%2C2%20%D0%9C%D0%B1%20%D0%B2%20%D1%87%D0%B0%D1%81.
8. https://www.statista.com/statistics/1309604/duolingo-quarterly-dau/
9. https://duolingoguides.com/how-many-people-use-duolingo/