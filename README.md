# Highload

[Задание](https://github.com/init/highload/blob/main/homework_architecture.md)

Репозиторий курсовой работы по дисциплине "Проектирование высоконагруженных систем"

[**1. Тема и целевая аудитория**](#1-тема-и-целевая-аудитория)
[**2. Расчет нагрузки**](#2-расчет-нагрузки)
[**3. Глобальная балансировка нагрузки**](#3-глобальная-балансировка-нагрузки)
[**4. Локальная балансировка нагрузки**](#4-локальная-балансировка-нагрузки)
[**5. Логическая схема БД**](#5-локальная-схема-бд)

[**Список использованных источников**](#список-использованных-источников)


## 1. Тема и целевая аудитория

Duolingo — бесплатная платформа для изучения языков, также имеющая курсы математики, музыки и шахматам[[1](https://ru.wikipedia.org/wiki/Duolingo)].

### Число активных пользователей

  * MAU на 1 квартал 2022 года: 49,2 млн[[2](https://investors.duolingo.com/static-files/d667f9d1-8f7f-418c-b116-e699a30a9826)]
  * DAU на 1 квартал 2022 года: 12,5 млн 
  * Средняя продолжительность посещения: 15 минут 39 секунд [[3](https://usesignhouse.com/blog/duolingo-stats/)]

### Целевая аудитория

* По странам[[4](https://usesignhouse.com/blog/duolingo-stats/)]:

  ![image](./images/cantry.jpg "Статистика использования по cтранам")
  Всего пользователей: 575 млн[[5](https://cooljugator.com/blog/duolingo-statistics/)]

### Требования к функционалу
  * Регистрация и авторизация
  * Выбор языка для изучения
  * Уроки (с делением на разделы и модули)
    - множественный выбор
    - сопоставление слов
    - аудирование
    - говорение
    - правописание
  * Система прогресса 
  * Ежедневная цель и трекер
  * Система напоминаний
  * Подписки, добавление в друзья, комментарии
  * Алфавит
  * Возможность изменения уроков их авторами

## 2. Расчет нагрузки

| Метрика                          | Значение    |
|:---------------------------------|:------------| 
| Месячная аудитория (MAU)         | 49,2 млн    |
| Дневная аудитория (DAU)          | 12,5 млн    | 
| Средняя продолжительность сессии | 15,65 минут | 

### Размер хранения в разбивке по типам данных

- Прирост в день:[[8](https://www.statista.com/statistics/1309604/duolingo-quarterly-dau/)]
  ![image](./images/dau.jpg "Статистика роста DAU")
- Прирост в месяц:
  ![image](./images/mau.jpg "Статистика роста MAU")

Согласно источнику[[6](https://hu.duolingo.com/privacy)], хранятся следующие индивидуальные пользовательские данные:
- основной профиль и учетные данные: возраст, email, номер телефона, имя, фамилия, биография, фото профиля;
- учебный прогресс и активность: изучаемые языки, статистика, достижения, история пройденных уроков и упражнений;
- пользовательский контент: комментарии на профиле;
- аудиоданные и транскрипты: аудиозаписи голоса с упражнений на произношение;
- cоциальные графы: cписки подписчиков и подписок.

Формулы:
- новых пользователей в день ≈ (DAU_конечное - DAU_начальное) / количество дней в периоде
- прирост в день ед/день = ед/пользователя × новых пользователей в день
- прирост в день объем/день = ед/день × средний размер единицы
- прирост в месяц ед/мес = ед/пользователя × новых пользователей в месяц
- прирост в месяц объем/мес = ед/мес × средний размер единицы

Новых пользователей в день: 
- (12.5 млн - 10.1 млн) / 90 дней = 2.4 млн / 90 = 26,667 пользователей/день

Новых пользователей в месяц:
- 26,700 пользователей/день × 30 дней = 801,000 пользователей/месяц

| Хранимые данные                   | Средний размер единицы | Ед/пользователя | Сколько единиц | Суммарный объем | Прирост в день | Прирост в месяц |
|:----------------------------------|:-----------------------|:----------------|:---------------|:----------------|:---------------|:----------------|
| Основной профиль и учетные данные | 5 КБ                   | 1               | 49,200,000     | 234.5 ГБ        | 130.4 МБ       | 3.8 ГБ          |
| Учебный прогресс и активность     | 50 КБ                  | 1               | 49,200,000     | 2.3 ТБ          | 1.3 ГБ         | 38.2 ГБ         |
| Пользовательский контент          | 2 КБ                   | 5               | 246,000,000    | 468.9 ГБ        | 260.7 МБ       | 7.6 ГБ          |
| Аудиоданные и транскрипты         | 4.8 МБ                 | 1               | 49,200,000     | 225.2 ТБ        | 125.1 ГБ       | 3.7 ТБ          |
| Социальные графы                  | 1 КБ                   | 10              | 492,000,000    | 468.9 ГБ        | 260.7 МБ       | 7.6 ГБ          |

Основной профиль и учетные данные:
- Сколько единиц: MAU (49.2 млн) × 1 = 49,200,000
- Суммарный объем: (49,200,000 × 5 КБ) / (1024×1024) = 234.5 ГБ
- Прирост в день: (26,700 × 5 КБ) / 1024 = 130.4 МБ
- Прирост в месяц: 130.4 МБ × 30 = 3.8 ГБ

Учебный прогресс и активность:
- Суммарный объем: (49,200,000 × 50 КБ) / (1024×1024) = 2.3 ТБ
- Прирост в день: (26,700 × 50 КБ) / 1024 = 1.3 ГБ

Пользовательский контент:
- Сколько единиц: MAU (49.2 млн) × 5 = 246,000,000
- Суммарный объем: (246,000,000 × 2 КБ) / (1024×1024) = 468.9 ГБ
- Прирост в день: (26,700 × 5 × 2 КБ) / 1024 = 260.7 МБ

Аудиоданные и транскрипты:
- Размер единицы: 2.4 МБ/мин × 2 минуты = 4.8 МБ
- Сколько единиц: MAU (49.2 млн) × 1 = 49,200,000
- Суммарный объем: (49,200,000 × 4.8 МБ) / 1024 = 225.2 ТБ
- Прирост в день: (26,700 × 4.8 МБ) / 1024 = 125.1 ГБ
- Прирост в месяц: 125.1 ГБ × 30 = 3.7 ТБ

Социальные графы:
- Сколько единиц: MAU (49.2 млн) × 10 = 492,000,000
- Суммарный объем: (492,000,000 × 1 КБ) / (1024×1024) = 468.9 ГБ
- Прирост в день: (26,700 × 10 × 1 КБ) / 1024 = 260.7 МБ
   
Допущения:
- Высокое качество(320kbps) аудиозаписи: 2,40 МБ/мин [[7](https://digitark.telia.ee/ru/era/%D0%B2%D1%81%D0%B5-%D1%82%D0%BE%D1%87%D0%BA%D0%B8-%D0%BD%D0%B0%D0%B4-%D0%B8%D1%82-%D0%BA%D0%B0%D0%BA-%D0%B2%D1%8B%D0%B1%D1%80%D0%B0%D1%82%D1%8C-%D0%BE%D0%B1%D1%8A%D0%B5%D0%BC-%D0%BC%D0%BE/#:~:text=%D0%9D%D0%B8%D0%B7%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%B0%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%BE%20%D0%B0%D1%83%D0%B4%D0%B8%D0%BE%20(96kpps)%20%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D1%83%D0%B5%D1%82,115%2C2%20%D0%9C%D0%B1%20%D0%B2%20%D1%87%D0%B0%D1%81.)]
- На говорение тратится ~2 минуты за сессию.

### RPS в разбивке по типам запросов

Формулы:
- суммарные действия в день = действий в день на пользователя ×  DAU
- средний RPS = суммарные действия в день / 86 400 (секунд в дне)

| Категория                 | Действие                           | Среднее количество в день             | Суммарные действия в день | Средний RPS |
|:--------------------------|:-----------------------------------|:--------------------------------------|:--------------------------|:------------|
| Регистрация и авторизация |                                    |                                       |                           |             |
|                           | Вход в аккаунт                     | 2                                     | 25 000 000                | ~289.4      |
| Работа с уроками          |                                    |                                       |                           |             |
|                           | Прохождение карточек / множ. выбор | 12                                    | 150 000 000               | ~1736.1     | 
|                           | Сопоставление слов                 | 5                                     | 62 500 000                | ~723.4      | 
|                           | Аудирование                        | 4                                     | 50 000 000                | ~578.7      | 
|                           | Говорение (произношение)           | 3                                     | 37 500 000                | ~434.0      | 
|                           | Правописание (ввод слова)          | 4                                     | 50 000 000                | ~578.7      | 
|                           | ИТОГО по урокам                    | 28                                    | 350 000 000               | ~4050.9     | 
| Система прогресса         |                                    |                                       |                           |             | 
|                           | Просмотр статистики                | 1                                     | 12 500 000                | ~144.7      | 
| Ежедневная цель           |                                    |                                       |                           |             |  
|                           | Отметка о выполнении               | 1                                     | 12 500 000                | ~144.7      |
| Система напоминаний       |                                    |                                       |                           |             |
|                           | Клик по push-уведомлению           | 0.5                                   | 6 250 000                 | ~72.3       |
| Социальные функции        |                                    |                                       |                           |             | 
|                           | Запрос на дружбу                   | 0.3                                   | 3 750 000                 | ~43.4       |
|                           | Комментарии                        | 1.5                                   | 18 750 000                | ~217.0      |
|                           | Просмотр профилей                  | 1                                     | 12 500 000                | ~144.7      |
|                           | ИТОГО по соц. функциям             | 2.8                                   | 35 000 000                | ~405.1      |
| Вспомогательные функции   |                                    |                                       |                           |             |
|                           | Просмотр алфавита                  | 0.2                                   | 2 500 000                 | ~28.9       |
|                           | Изменение уроков (автор)           | 0.1                                   | 1 250 000                 | ~14.5       |
|                           | ВСЕГО СУММАРНО                     | 35.7                                  | ~446 250 000              | ~5165.9     |

### Сетевой трафик

Формулы:
- нагрузка Гбит/с = (средний трафик на действие Кб × RPS × 8) / 1024 × 1024

| Действие                     | КБ на действие | RPS     | Нагрузка (Гбит/с) | Нагрузка (Гбит/день) |
|:-----------------------------|:---------------|:--------|:------------------|:---------------------|
| Вход в аккаунт               | 2              | 289.4   | 0.45              | 381.47               |
| Прохождение карточек         | 8              | 1,736.1 | 10.85             | 9,155.27             |
| Сопоставление слов           | 12             | 723.4   | 6.78              | 5,722.05             |
| Аудирование                  | 15             | 578.7   | 6.78              | 5,722.05             |
| Говорение                    | 5              | 434.0   | 1.70              | 1,430.51             |
| Правописание                 | 3              | 578.7   | 1.36              | 1,144.41             |
| Просмотр статистики          | 25             | 144.7   | 28.26             | 2,384.19             |
| Отметка о выполнении         | 1              | 144.7   | 1.13              | 95.37                |
| Клик по push-уведомлению     | 1              | 72.3    | 0.56              | 47.68                |
| Запрос на дружбу             | 2              | 43.4    | 0.68              | 57.22                |
| Комментарии                  | 8              | 217.0   | 13.56             | 1,144.41             |
| Просмотр профилей            | 15             | 144.7   | 16.96             | 1,430.51             |
| Просмотр алфавита            | 50             | 28.9    | 11.29             | 953.67               |
| Изменение уроков             | 100            | 14.5    | 11.33             | 953.67               |
| ВСЕГО СУММАРНО               | -              | 5,165.9 | 111.69            | 31,123.88            |

Вход в аккаунт:
- (2 КБ × 289.4 RPS × 8) / 1024 = 0.45 Гбит/с

Прохождение карточек:
- (8 КБ × 1,736.1 RPS × 8) / 1024 = 10.85 Гбит/с

Сопоставление слов:
- (12 КБ × 723.4 RPS × 8) / 1024 = 6.78 Гбит/с

Аудирование:
- (15 КБ × 578.7 RPS × 8) / 1024 = 6.78 Гбит/с

Просмотр статистики:
- (25 КБ × 144.7 RPS × 8) / 1024 = 28.26 Гбит/с

Изменение уроков:
- (100 КБ × 14.5 RPS × 8) / 1024 = 11.33 Гбит/с

| Метрика                      | Значение                                |
|:-----------------------------|:----------------------------------------|
| Общий суточный трафик        | 31,123.88 Гбит/день (см. табл. трафика) |
| Трафик на пользователя       | 0.305 МБ/день                           |
| Средний размер действия      | 8.75 КБ                                 |
| Действий на пользователя     | 35.7 действий/день (см. табл. RPS)      |

Средний размер на действие:
- 31,123,880 Мбит ÷ 446,250,000 действий ≈ 0.07 Мбит/действие = 8.75 КБ/действие

Трафик на пользователя:
- 35.7 действий/день × 8.75 КБ/действие = 312.4 КБ/день = 0.305 МБ/день

### Пиковый коэффициент и коэффициент надежности

Формулы:
- k<sub>пик</sub> = пиковая нагрузка / средняя нагрузка
- k<sub>надежн</sub> = доступные ресурсы / необходимые ресурсы

Пиковая нагрузка:
- 111.69 Гбит/с × 2 = 223.38 Гбит/с 
Нагрузка с резервом:
- 31,123,880 Мбит × 1.5 = 35.07 Гбит/с

Допущения:
- k<sub>пик</sub> = 2
- k<sub>надежн</sub> = 1.25

## 3. Глобальная балансировка нагрузки

### Функциональное разбиение по доменам

Отсутствует

### Обоснование расположения ДЦ (влияние на продуктовые метрики)

Из статистики получаем, что большая часть аудитории приходится на США, Бразилию, Великобританию, Мексику, поэтому распределим ДЦ следующим образом:

| Регион                   | Ключевые ДЦ                              | Покрытие                                    | Доля |
|:-------------------------|:-----------------------------------------|:--------------------------------------------|:-----|
| США                      | Вирджиния, Орегон, Техас                 | США, Канада, Мексика                        | ~26% |
| Бразилия                 | Сан-Паулу                                | Бразилия, Латинская Америка                 | ~7%  |
| Великобритания, Германия | Лондон, Франкфурт                        | Великобритания, Германия, Франция, Бенилюкс | ~10% |
| Польша                   | Варшава                                  | Восточная Европа, Россия, СНГ               | ~5%  |              

#### США: 

- Крупнейший рынок. Несколько ДЦ для снижения задержки и обеспечения отказоустойчивости. Вирджиния - восточное побережье, Орегон - западное побережье, Техас - центр и юг.

#### Бразилия:

- Центральное расположение для покрытия всего региона. Сан-Паулу - крупнейший технологический хаб Южной Америки.

#### Великобритания, Германия:

- Два ключевых технологических хаба для покрытия основных рынков Европы. Лондон - западная Европа, Франкфурт - центральная Европа.

#### Польша:

- Центральное расположение для покрытия восточноевропейского региона с оптимальной задержкой для всех стран.

### Расчет распределение запросов по типам запросов по ДЦ

| Действие                               | Требование к задержке | Методы распределения в GSLB |
|:---------------------------------------|:----------------------|:----------------------------|
| Регистрация, авторизация               | низкая                | наименее загруженный ДЦ     |
| Главная страница, загрузка уроков      | средняя               | наименее загруженный ДЦ     |
| Упражнения на произношение             | критично важная       | ДЦ с наименьшей задержкой   |
| Упражнения на правописание             | критично важная       | ДЦ с наименьшей задержкой   |
| Прослушивание аудиозаписей, упражнения | средняя               | ближайшая геолокация        |

### Схема DNS балансировки

Для распределения пользователей между ДЦ на разных континентах будет использоваться Geo-based DNS. 

Этот метод предпочтительнее простого Round-Robin, так как серверы находятся в разных полушариях и задержки между ними велики. 

DNS-система направляет пользователя в географически ближайший дата-центр

### Схема Anycast балансировки

Внутри крупных регионов, таких как Северная Америка и Европа, DNS-балансировка может быть недостаточно точной из-за того, что провайдеры часто используют глобальные DNS-серверы, не учитывающие задержки между городами. 

Поэтому здесь будет применяться BGP Anycast.
Один и тот же IP-адрес анонсируется в интернет сразу из нескольких ДЦ. Протокол маршрутизации BGP автоматически направляет трафик пользователя в топологически ближайший ДЦ. Это минимизирует задержку для конечных пользователей.

Для реализации требуется собственный номер автономной системы (AS) и согласование с вышестоящими провайдерами.

### Механизм регулировки трафика между ДЦ

В зонах покрытия, где пользователи могут быть обслужены разными ДЦ (например, на границе их ответственности), трафик будет динамически перераспределяться в зависимости от текущей загрузки каждого ДЦ. Это обеспечивает оптимальное использование ресурсов и отказоустойчивость.

## 4. Локальная балансировка нагрузки

В каждом ДЦ развернут кластер Kubernetes, который обеспечивает оркестрацию и базовое управление состоянием сервисов.

Для балансировки трафика между подами внутри кластера используется каскадная схема L4 → L7

### Аудио-стриминг (упражнения на аудирование и говорение)

Для обработки аудиопотоков в реальном времени, критичных к задержкам, применяется балансировка нагрузки на транспортном уровне L4.
В качестве базового решения используется технология LVS (Linux Virtual Server) с методом маршрутизации Direct Routing (DR).
Данный подход обеспечивает максимальную производительность за счет того, что ответные пакеты от серверов приложений передаются напрямую клиенту,
минуя балансировщик на обратном пути.
Важным условием работы в этом режиме является размещение всех серверов в пределах одной физической сети (broadcast-домена).
Алгоритм балансировки реализован через модуль NGINX stream с применением стратегии Least Connections, 
которая гарантирует распределение новых входящих аудиосоединений на серверы с наименьшим количеством активных подключений, 
что особенно эффективно для долгоживущих медиасессий.

### HTTP/HTTPS запросы (Веб-интерфейс, API, прогресс)

Для основного веб-трафика, требующего интеллектуальной маршрутизации, применяется балансировка нагрузки на уровне приложений L7. 
В качестве технологического решения используется NGINX Ingress Controller, развернутый в кластере Kubernetes. 
Алгоритм балансировки построен по принципу наименьших соединений Least Connections, 
когда каждый новый запрос направляется на бэкенд с минимальным количеством активных подключений, 
что обеспечивает равномерное распределение нагрузки для запросов различной продолжительности.
Балансировщик уровня L7 выполняет критически важные функции, включая SSL Termination - расшифровку HTTPS-трафика с последующей передачей данных бэкендам по HTTP, 
что значительно разгружает серверы приложений от ресурсоемких операций шифрования. 
Важной особенностью является буферизация запросов и ответов, которая обеспечивает защиту бэкендов от медленных клиентов. 
Также реализована интеллектуальная маршрутизация на основе путей запросов, позволяющая направлять трафик к различным сервисам в зависимости от URL.

### Резервирование и отказоустойчивость

Для обеспечения высокой доступности применяется многоуровневая стратегия резервирования.

- Схема резервирования: N+1. На каждый ДЦ резервируется один дополнительный балансировщик каждого типа сверх необходимого по расчетной нагрузке.
- Механизм отказоустойчивости: Для L4-балансировщиков (LVS) используется Keepalived. Этот протокол реализует механизм Virtual Router Redundancy Protocol (VRRP), 
который непрерывно проверяет доступность активного балансировщика и автоматически заменяет его резервным в случае падения, обеспечивая бесперебойную работу.

### Расчет необходимого количества балансировщиков

Формула для L4-балансировщиков:
- N (L4) = ceil(Пиковая нагрузка на ДЦ (Гбит/с) / 100) + 1

| Расположение ДЦ | Регион                   | Пиковая нагрузка (Гбит/с) | N (L4) | N (L7) |
|-----------------|--------------------------|---------------------------|--------|--------|
| Вирджиния       | США                      | 150                       | 3      | 2      |
| Орегон          | США                      | 100                       | 2      | 2      |
| Техас           | США                      | 100                       | 2      | 2      |
| Сан-Паулу       | Бразилия                 | 50                        | 2      | 2      |
| Лондон          | Великобритания, Германия | 80                        | 2      | 2      |
| Франкфурт       | Великобритания, Германия | 80                        | 2      | 2      |
| Варшава         | Польша                   | 30                        | 2      | 2      |

## 5. Логическая схема БД
![image](./images/shema.png "Логическая схема БД")
### Описание таблиц
#### Таблица Пользователи
| Поле                | Тип данных  | Размер (байт) | Описание                              |
|---------------------|-------------|---------------|---------------------------------------|
| user_id             | UUID        | 16            | Уникальный идентификатор пользователя |
| username            | TEXT        | 50            | Логин для входа в систему             |
| email               | TEXT        | 100           | Электронная почта                     |
| phone               | TEXT        | 20            | Номер телефона (опционально)          |
| first_name          | TEXT        | 50            | Имя пользователя                      |
| last_name           | TEXT        | 50            | Фамилия пользователя                  |
| bio                 | TEXT        | 500           | Биография "о себе"                    |
| profile_picture_url | TEXT        | 200           | Ссылка на аватарку                    |
| birth_date          | DATE        | 4             | Дата рождения                         |
| created_at          | TIMESTAMPTZ | 8             | Дата регистрации                      |
| updated_at          | TIMESTAMPTZ | 8             | Дата последнего обновления            |

#### Таблица Языки
| Поле        | Тип данных  | Размер (байт) | Описание                              |
|-------------|-------------|---------------|---------------------------------------|
| language_id | UUID        | 16            | Уникальный идентификатор языка        |
| code        | TEXT        | 5             | Код языка ('en', 'es', 'fr')          |
| name        | TEXT        | 20            | Название языка ('English', 'Spanish') |

#### Таблица Курсы
| Поле               | Тип данных  | Размер (байт) | Описание                       |
|--------------------|-------------|---------------|--------------------------------|
| course_id          | UUID        | 16            | Уникальный идентификатор курса |
| source_language_id | UUID        | 16            | Исходный язык пользователя     |
| target_language_id | UUID        | 16            | Язык для изучения              |
| name               | TEXT        | 100           | Название курса                 |
| description        | TEXT        | 500           | Описание курса                 |
| created_at         | TIMESTAMPTZ | 8             | Дата создания курса            |

#### Таблица Подписки на курсы
| Поле               | Тип данных   | Размер (байт)   | Описание             |
|--------------------|--------------|-----------------|----------------------|
| user_id            | UUID         | 16              | ID пользователя      |
| course_id          | UUID         | 16              | ID курса             |
| started_at         | TIMESTAMPTZ  | 8               | Дата начала обучения |
| current_section_id | UUID         | 16              | Текущий раздел       |
| total_xp           | INTEGER      | 4               | Всего опыта за курс  |

#### Таблица Разделы курса
| Поле        | Тип данных | Размер (байт) | Описание                         |
|-------------|------------|---------------|----------------------------------|
| section_id  | UUID       | 16            | Уникальный идентификатор раздела |
| course_id   | UUID       | 16            | ID курса                         |
| title       | TEXT       | 100           | Название раздела                 |
| description | TEXT       | 300           | Описание раздела                 |
| order_index | INTEGER    | 4             | Порядковый номер в курсе         |

#### Таблица Модули
| Поле        | Тип данных | Размер (байт) | Описание                        |
|-------------|------------|---------------|---------------------------------|
| module_id   | UUID       | 16            | Уникальный идентификатор модуля |
| section_id  | UUID       | 16            | ID раздела                      |
| title       | TEXT       | 100           | Название модуля                 |
| description | TEXT       | 300           | Описание модуля                 |
| order_index | INTEGER    | 4             | Порядковый номер в разделе      |

#### Таблица Уроки
| Поле                       | Тип данных | Размер (байт) | Описание                       |
|----------------------------|------------|---------------|--------------------------------|
| lesson_id                  | UUID       | 16            | Уникальный идентификатор урока |
| module_id                  | UUID       | 16            | ID модуля                      |
| title                      | TEXT       | 100           | Название урока                 |
| instruction                | TEXT       | 200           | Инструкция к уроку             |
| order_index                | INTEGER    | 4             | Порядковый номер в модуле      |
| estimated_duration_minutes | INTEGER    | 4             | Примерная длительность         |
| difficulty_level           | INTEGER    | 4             | Уровень сложности (1-5)        |

#### Таблица Типы упражнений
| Поле              | Тип данных | Размер (байт) | Описание                |
|-------------------|------------|---------------|-------------------------|
| exercise_type_id  | UUID       | 16            | Уникальный идентификатор|
| name              | TEXT       | 20            | Название типа           |
| description       | TEXT       | 100           | Описание типа           |

#### Таблица Упражнения уроков
| Поле              | Тип данных | Размер (байт) | Описание                |
|-------------------|------------|---------------|-------------------------|
| exercise_id       | UUID       | 16            | Уникальный идентификатор|
| lesson_id         | UUID       | 16            | ID урока                |
| exercise_type_id  | UUID       | 16            | Тип упражнения          |
| order_index       | INTEGER    | 4             | Порядок в уроке         |
| title             | TEXT       | 100           | Название упражнения     |
| instruction       | TEXT       | 200           | Инструкция              |
| points_value      | INTEGER    | 4             | Баллы за выполнение     |
| time_limit_seconds| INTEGER    | 4             | Лимит времени           |

#### Таблица Упражнения с множественным выбором
| Поле                  | Тип данных | Размер (байт) | Описание                |
|-----------------------|------------|---------------|-------------------------|
| exercise_id           | UUID       | 16            | ID упражнения           |
| question_text         | TEXT       | 200           | Текст вопроса           |
| question_audio_url    | TEXT       | 200           | Аудио вопроса           |
| options               | TEXT[]     | 200           | Варианты ответов        |
| correct_option_index  | INTEGER    | 4             | Индекс правильного ответа|
| explanation           | TEXT       | 300           | Объяснение              |
| hint_text             | TEXT       | 100           | Подсказка               |

#### Таблица Упражнения на сопоставление слов
| Поле              | Тип данных | Размер (байт) | Описание                |
|-------------------|------------|---------------|-------------------------|
| exercise_id       | UUID       | 16            | ID упражнения           |
| source_words      | TEXT[]     | 200           | Слова на исходном языке |
| target_words      | TEXT[]     | 200           | Слова на целевом языке  |
| correct_mappings  | JSONB      | 500           | Правильные сопоставления|
| shuffle_options   | BOOLEAN    | 1             | Перемешивать варианты   |

#### Таблица Упражнения на аудирование
| Поле              | Тип данных | Размер (байт) | Описание                |
|-------------------|------------|---------------|-------------------------|
| exercise_id       | UUID       | 16            | ID упражнения           |
| audio_url         | TEXT       | 200           | Ссылка на аудио         |
| target_transcript | TEXT       | 500           | Транскрипт              |
| question_text     | TEXT       | 200           | Вопрос                  |
| options           | TEXT[]     | 200           | Варианты ответов        |
| correct_answer    | TEXT       | 50            | Правильный ответ        |
| playback_count    | INTEGER    | 4             | Количество прослушиваний|
| slow_playback_url | TEXT       | 200           | Медленное воспроизведение|

#### Таблица Упражнения на говорение
| Поле                      | Тип данных | Размер (байт) | Описание                |
|---------------------------|------------|---------------|-------------------------|
| exercise_id               | UUID       | 16            | ID упражнения           |
| target_phrase             | TEXT       | 100           | Целевая фраза           |
| language_code             | TEXT       | 5             | Код языка               |
| expected_transcript       | TEXT       | 200           | Ожидаемый транскрипт    |
| pronunciation_tips        | TEXT       | 200           | Советы по произношению  |
| min_confidence_threshold  | DECIMAL    | 4             | Минимальная уверенность |
| sample_audio_url          | TEXT       | 200           | Пример произношения     |

#### Таблица Упражнения на правописание
| Поле              | Тип данных | Размер (байт) | Описание                |
|-------------------|------------|---------------|-------------------------|
| exercise_id       | UUID       | 16            | ID упражнения           |
| target_word       | TEXT       | 50            | Целевое слово           |
| word_audio_url    | TEXT       | 200           | Аудио слова             |
| hint_text         | TEXT       | 100           | Подсказка               |
| max_attempts      | INTEGER    | 4             | Максимум попыток        |
| accepted_variants | TEXT[]     | 100           | Принимаемые варианты    |

#### Таблица Буква
| Поле               | Тип данных | Размер (байт) | Описание                      |
|--------------------|------------|---------------|-------------------------------|
| alphabet_id        | UUID       | 16            | Уникальный идентификатор буквы|
| language_id        | UUID       | 16            | ID языка                      |
| letter             | TEXT       | 5             | Буква/символ                  |
| letter_name        | TEXT       | 50            | Название буквы                |
| pronunciation      | TEXT       | 50            | Произношение                  |
| audio_url          | TEXT       | 200           | Аудио произношения            |
| example_word       | TEXT       | 50            | Пример слова                  |
| example_translation| TEXT       | 50            | Перевод примера               |
| letter_image_url   | TEXT       | 200           | Изображение буквы             |
| order_index        | INTEGER    | 4             | Порядок в алфавите            |

#### Таблица Алфавит

| Поле           | Тип данных | Размер (байт) | Описание                                              |
|----------------|------------|---------------|-------------------------------------------------------|
| exercise_id    | UUID       | 16            | ID упражнения                                         |
| alphabet_id    | UUID       | 16            | ID буквы из алфавита                                  |
| exercise_type  | TEXT       | 20            | Тип: 'letter_recognition', 'pronunciation', 'writing' |
| instruction    | TEXT       | 200           | Инструкция к упражнению                               |
| target_letter  | TEXT       | 5             | Изучаемая буква                                       |
| options        | TEXT[]     | 200           | Варианты для выбора                                   |
| correct_answer | TEXT       | 50            | Правильный ответ                                      |
| hint_text      | TEXT       | 100           | Подсказка                                             |

#### Таблица Прогресс пользователя
| Поле         | Тип данных  | Размер (байт) | Описание                      |
|--------------|-------------|---------------|-------------------------------|
| user_id      | UUID        | 16            | ID пользователя               |
| lesson_id    | UUID        | 16            | ID урока                      |
| course_id    | UUID        | 16            | ID курса                      |
| is_completed | BOOLEAN     | 1             | Флаг завершения урока         |
| score        | INTEGER     | 4             | Количество правильных ответов |
| max_score    | INTEGER     | 4             | Общее количество вопросов     |
| started_at   | TIMESTAMPTZ | 8             | Время начала урока            |
| completed_at | TIMESTAMPTZ | 8             | Время завершения урока        |
| updated_at   | TIMESTAMPTZ | 8             | Время последнего обновления   |

#### Таблица Попытки упражнений
| Поле              | Тип данных  | Размер (байт) | Описание                |
|-------------------|-------------|---------------|-------------------------|
| attempt_id        | UUID        | 16            | Уникальный идентификатор|
| user_id           | UUID        | 16            | ID пользователя         |
| exercise_id       | UUID        | 16            | ID упражнения           |
| user_answer       | JSONB       | 500           | Ответ пользователя      |
| is_correct        | BOOLEAN     | 1             | Правильность ответа     |
| points_earned     | INTEGER     | 4             | Заработанные баллы      |
| time_spent_seconds| INTEGER     | 4             | Затраченное время       |
| attempted_at      | TIMESTAMPTZ | 8             | Время попытки           |

#### Таблица Аудиоданные
| Поле             | Тип данных  | Размер (байт) | Описание                        |
|------------------|-------------|---------------|---------------------------------|
| audio_id         | UUID        | 16            | Уникальный идентификатор аудио  |
| user_id          | UUID        | 16            | ID пользователя                 |
| exercise_id      | UUID        | 16            | ID упражнения                   |
| audio_file_url   | TEXT        | 200           | Ссылка на файл в Object Storage |
| transcript       | TEXT        | 1000          | Транскрипт от ASR               |
| confidence_score | DECIMAL     | 4             | Уверенность распознавания       |
| duration_seconds | INTEGER     | 4             | Длительность аудио в секундах   |
| created_at       | TIMESTAMPTZ | 8             | Время создания записи           |

#### Таблица Настройки уведомлений
| Поле                   | Тип данных  | Размер (байт) | Описание                |
|------------------------|-------------|---------------|-------------------------|
| user_id                | UUID        | 16            | ID пользователя         |
| daily_reminder_enabled | BOOLEAN     | 1             | Ежедневные напоминания  |
| reminder_time          | TIME        | 8             | Время напоминания       |
| timezone               | TEXT        | 20            | Часовой пояс            |
| push_notifications     | BOOLEAN     | 1             | Push-уведомления        |
| email_notifications    | BOOLEAN     | 1             | Email-уведомления       |
| streak_reminders       | BOOLEAN     | 1             | Напоминания о серии     |
| goal_reminders         | BOOLEAN     | 1             | Напоминания о целях     |
| updated_at             | TIMESTAMPTZ | 8             | Время обновления        |

#### Таблица Напоминания
| Поле         | Тип данных  | Размер (байт) | Описание                |
|--------------|-------------|---------------|-------------------------|
| reminder_id  | UUID        | 16            | Уникальный идентификатор|
| user_id      | UUID        | 16            | ID пользователя         |
| reminder_type| TEXT        | 20            | Тип напоминания         |
| scheduled_at | TIMESTAMPTZ | 8             | Время отправки          |
| title        | TEXT        | 100           | Заголовок               |
| message      | TEXT        | 500           | Сообщение               |
| status       | TEXT        | 10            | Статус                  |
| sent_at      | TIMESTAMPTZ | 8             | Время отправки          |
| created_at   | TIMESTAMPTZ | 8             | Время создания          |

#### Таблица Подписки
| Поле        | Тип данных  | Размер (байт) | Описание                              |
|-------------|-------------|---------------|---------------------------------------|
| user_id     | UUID        | 16            | ID пользователя (на кого подписались) |
| follower_id | UUID        | 16            | ID подписчика                         |
| created_at  | TIMESTAMPTZ | 8             | Время подписки                        |

#### Таблица Посты пользователей
| Поле       | Тип данных  | Размер (байт) | Описание                       |
|------------|-------------|---------------|--------------------------------|
| post_id    | UUID        | 16            | Уникальный идентификатор поста |
| user_id    | UUID        | 16            | ID автора                      |
| content    | TEXT        | 1000          | Текст поста                    |
| created_at | TIMESTAMPTZ | 8             | Время публикации               |

#### Таблица Комментарии
| Поле       | Тип данных  | Размер (байт) | Описание                             |
|------------|-------------|---------------|--------------------------------------|
| comment_id | UUID        | 16            | Уникальный идентификатор комментария |
| post_id    | UUID        | 16            | ID поста                             |
| user_id    | UUID        | 16            | ID автора комментария                |
| content    | TEXT        | 500           | Текст комментария                    |
| created_at | TIMESTAMPTZ | 8             | Время комментария                    |

#### Таблица Достижения
| Поле           | Тип данных | Размер (байт) | Описание                            |
|----------------|------------|---------------|-------------------------------------|
| achievement_id | UUID       | 16            | Уникальный идентификатор достижения |
| name           | TEXT       | 50            | Название достижения                 |
| description    | TEXT       | 200           | Описание как получить               |
| icon_url       | TEXT       | 200           | Ссылка на иконку                    |

#### Таблица Достижения пользователей
| Поле           | Тип данных  | Размер (байт) | Описание        |
|----------------|-------------|---------------|-----------------|
| user_id        | UUID        | 16            | ID пользователя |
| achievement_id | UUID        | 16            | ID достижения   |
| unlocked_at    | TIMESTAMPTZ | 8             | Время получения |

#### Таблица Ежедневные цели
| Поле               | Тип данных | Размер (байт) | Описание                   |
|--------------------|------------|---------------|----------------------------|
| user_id            | UUID       | 16            | ID пользователя            |
| goal_type          | TEXT       | 10            | Тип цели ('xp', 'lessons') |
| target_value       | INTEGER    | 4             | Целевое значение           |
| current_value      | INTEGER    | 4             | Текущее значение           |
| streak_count       | INTEGER    | 4             | Текущая серия дней         |
| last_activity_date | DATE       | 4             | Дата последней активности  |


## Список использованных источников
1. https://ru.wikipedia.org/wiki/Duolingo
2. https://investors.duolingo.com/static-files/d667f9d1-8f7f-418c-b116-e699a30a9826
4. https://usesignhouse.com/blog/duolingo-stats/
5. https://cooljugator.com/blog/duolingo-statistics/
6. https://hu.duolingo.com/privacy
7. https://digitark.telia.ee/ru/era/%D0%B2%D1%81%D0%B5-%D1%82%D0%BE%D1%87%D0%BA%D0%B8-%D0%BD%D0%B0%D0%B4-%D0%B8%D1%82-%D0%BA%D0%B0%D0%BA-%D0%B2%D1%8B%D0%B1%D1%80%D0%B0%D1%82%D1%8C-%D0%BE%D0%B1%D1%8A%D0%B5%D0%BC-%D0%BC%D0%BE/#:~:text=%D0%9D%D0%B8%D0%B7%D0%BA%D0%BE%D0%B5%20%D0%BA%D0%B0%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%BE%20%D0%B0%D1%83%D0%B4%D0%B8%D0%BE%20(96kpps)%20%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D1%83%D0%B5%D1%82,115%2C2%20%D0%9C%D0%B1%20%D0%B2%20%D1%87%D0%B0%D1%81.
8. https://www.statista.com/statistics/1309604/duolingo-quarterly-dau/
9. https://duolingoguides.com/how-many-people-use-duolingo/
